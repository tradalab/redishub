<?xml version="1.0" encoding="utf-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">

  <Package
    Name="$(var.ProductName)"
    Manufacturer="$(var.Manufacturer)"
    Version="$(var.ProductVersion)"
    UpgradeCode="deae281f-e7ee-41cd-bc53-b3d37b5b3737"
    Scope="perMachine">

    <!-- Upgrade -->
    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />

    <!-- Embedded CAB -->
    <MediaTemplate EmbedCab="yes" />

    <!-- ARP metadata -->
    <Property Id="ARPPRODUCTICON" Value="RedisHubIcon" />
    <Property Id="ARPHELPLINK" Value="https://github.com/tradalab/redishub" />
    <Property Id="ARPURLINFOABOUT" Value="https://redishub.tradalab.com" />
    <Property Id="ARPNOREPAIR" Value="1" />

    <!-- Icon -->
    <Icon Id="RedisHubIcon" SourceFile="$(var.BinPath)\RedisHub.ico" />

    <!-- ===================== -->
    <!-- INSTALL DIRECTORIES   -->
    <!-- ===================== -->

    <StandardDirectory Id="ProgramFilesFolder">
      <Directory Id="INSTALLFOLDERROOT" Name="$(var.Manufacturer)">
        <Directory Id="INSTALLFOLDER" Name="$(var.ProductName)">

          <Component Id="MainExecutable" Guid="b3e05cf1-55c0-4c27-94a3-1a31a7fb2f44">
            <File
              Id="RedisHubExe"
              Source="$(var.BinPath)\RedisHub.exe"
              KeyPath="yes" />
          </Component>

        </Directory>
      </Directory>
    </StandardDirectory>

    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="TradaLabPrograms" Name="$(var.Manufacturer)">
        <Directory Id="ApplicationProgramsFolder" Name="$(var.ProductName)">

          <!-- Start Menu shortcuts -->
          <Component Id="StartMenuShortcut" Guid="a2f88b22-1e5b-47c6-9f8d-69f8a3b8d0d2">

            <Shortcut
              Id="StartMenuShortcutExe"
              Directory="ApplicationProgramsFolder"
              Name="$(var.ProductName)"
              Description="${var.ProductDesc}"
              Target="[INSTALLFOLDER]RedisHub.exe"
              WorkingDirectory="INSTALLFOLDER"
              Icon="RedisHubIcon" />

            <Shortcut
              Id="UninstallShortcut"
              Directory="ApplicationProgramsFolder"
              Name="Uninstall $(var.ProductName)"
              Description="Uninstall $(var.ProductName)"
              Target="[SystemFolder]msiexec.exe"
              Arguments="/x [ProductCode] /qb"
              Icon="RedisHubIcon" />

            <RemoveFolder
              Id="RemoveApplicationProgramsFolder"
              Directory="ApplicationProgramsFolder"
              On="uninstall" />

            <RemoveFolder
              Id="RemoveTradaLabPrograms"
              Directory="TradaLabPrograms"
              On="uninstall" />

            <RegistryValue
              Root="HKCU"
              Key="Software\RedisHub"
              Name="StartMenuInstalled"
              Type="integer"
              Value="1"
              KeyPath="yes" />

          </Component>

        </Directory>
      </Directory>
    </StandardDirectory>

    <StandardDirectory Id="DesktopFolder">
      <Component Id="DesktopShortcut" Guid="7b9c22f9-17f8-4d7c-a91b-15b5f86a4d65">

        <Shortcut
          Id="DesktopShortcutExe"
          Directory="DesktopFolder"
          Name="$(var.ProductName)"
          Description="${var.ProductDesc}"
          Target="[INSTALLFOLDER]RedisHub.exe"
          WorkingDirectory="INSTALLFOLDER"
          Icon="RedisHubIcon" />

        <RegistryValue
          Root="HKCU"
          Key="Software\RedisHub"
          Name="DesktopShortcut"
          Type="integer"
          Value="1"
          KeyPath="yes" />

      </Component>
    </StandardDirectory>

    <!-- ===================== -->
    <!-- COMPONENT GROUP       -->
    <!-- ===================== -->

    <ComponentGroup Id="ProductComponents">
      <ComponentRef Id="MainExecutable" />
      <ComponentRef Id="StartMenuShortcut" />
      <ComponentRef Id="DesktopShortcut" />
    </ComponentGroup>

    <!-- ===================== -->
    <!-- FEATURE               -->
    <!-- ===================== -->

    <Feature Id="MainFeature" Title="$(var.ProductName)" Level="1">
      <ComponentGroupRef Id="ProductComponents" />
    </Feature>

  </Package>

</Wix>
